<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
async function fetchM3U() {
  const response = await fetch('combined_playlist.m3u');
  const text = await response.text();
  const lines = text.split('\n');
  const channels = [];
  for (let i = 0; i < lines.length; i++) {
    if (lines[i].startsWith('#EXTINF')) {
      const title = lines[i].split(',')[1] || 'Untitled';
      const url = lines[i + 1]?.trim();
      if (url && url.startsWith('http')) {
        channels.push({ title, url });
      }
    }
  }
  return channels;
}

function playStream(url) {
  const video = document.getElementById('video');

  if (Hls.isSupported()) {
    if (window.hls) {
      window.hls.destroy();
    }

    // âœ… Optimized HLS.js config for faster loading
    window.hls = new Hls({
      maxBufferLength: 10,      // Keep small buffer for quick start
      maxMaxBufferLength: 30,   // Prevent excessive buffering
      liveSyncDuration: 3,      // Keep near live edge
      liveMaxLatencyDuration: 10,
      startFragPrefetch: true,  // Preload next fragment before playing
      enableWorker: true,       // Use worker thread for parsing
      lowLatencyMode: true,     // Low latency for live streams
      manifestLoadingTimeOut: 20000, // Timeout for manifest
      fragLoadingTimeOut: 20000     // Timeout for segments
    });

    window.hls.loadSource(url);
    window.hls.attachMedia(video);
    window.hls.on(Hls.Events.MANIFEST_PARSED, () => {
      video.play();
    });
  } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = url;
    video.addEventListener('loadedmetadata', () => {
      video.play();
    });
  }
}

async function init() {
  const channels = await fetchM3U();
  const list = document.getElementById('channelList');

  if (!channels.length) {
    list.innerHTML = "<p style='color:red;text-align:center;'>No channels available</p>";
    return;
  }

  channels.forEach(({ title, url }) => {
    const div = document.createElement('div');
    div.className = 'channel';
    div.textContent = title;
    div.onclick = () => playStream(url);
    list.appendChild(div);
  });

  playStream(channels[0].url); // Auto play first channel
}

init();
</script>
